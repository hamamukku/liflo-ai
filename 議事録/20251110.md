議事録（ファイル変更）

プロジェクト: Liflo（バックエンド記録永続化・レビュー修正）
日付: 2025-11-10
作成者: 村木
参加者: 浜崎, 村木

1) 概要（要約）

変更タイプ: バックエンド構成修正／Prismaマイグレーション／フロントエンドUI更新

目的:

記録データが「振り返り」画面遷移後に消える問題を解消。

Record モデルを Prisma 永続化方式へ切り替え、DB上で保持。

「保存」動作時の Foreign Key エラーを修正し、ゲストユーザーでも記録可能にした。

「振り返り」ページの白画面表示・英語表記を修正し、日本語UIへ統一。

影響範囲:

バックエンド：Prismaモデル／API /api/records /api/review

フロント：RecordPage／ReviewPage／LifloFetch共通ロジック

2) 変更ファイル

api/src/server.ts

api/src/dev-server.ts

api/prisma/schema.prisma

api/src/repositories/records.repository.ts

api/src/services/auth.service.ts

api/src/routes/auth.routes.ts

web/src/pages/RecordPage.tsx

web/src/pages/ReviewPage.tsx

web/src/lib/api.ts

3) 変更の詳細（技術的に）

バックエンド

Prisma スキーマに Record モデルを追加：

model Record {
  id        Int      @id @default(autoincrement())
  text      String
  createdAt DateTime @default(now())
}


MemoryRecordRepository → PrismaRecordRepository に変更し、永続化を実現。

外部キー制約（userId）を削除して、ゲスト投稿も可能に。

/api/auth/signup の例外処理を拡張し、詳細な500エラー原因をログ出力。

/api/review /api/review/stats のレスポンス構造を {status,message,data} に統一。

フロントエンド

「振り返り」ページ（ReviewPage.tsx）の描画エラー防止：

data?.map() → Array.isArray(data) ? data.map() : []

英語文言を日本語化（例：No records yet. → まだ記録がありません。）

LifloFetch関数で return json.data as T に統一し、statusレスポンスを安全に扱う。

記録送信後 /review に即反映されるよう再フェッチを調整。

4) テスト / 検証手順

Prismaマイグレーション

npx prisma generate
npx prisma migrate dev --name add-record-model


保存テスト

/record で文章を入力→「保存」ボタン押下

エラーが出ないこと（ForeignKeyConstraint消滅）

表示テスト

/review で記録が即時反映されること。

記録なし時は「まだ記録がありません」と表示される。

再訪問テスト

/record に戻ってもデータが消えず残っていること。

5) デプロイ手順

Prismaマイグレーションを適用 (prisma migrate deploy)

バックエンドをデプロイ

フロントを再ビルド (npm run build)

キャッシュクリアを実施（Viteのキャッシュ含む）
ロールバック方法:
prisma migrate resolve --rolled-back により旧マイグレーションへ戻す。

6) リスク評価・決定事項

リスク:

将来的にユーザー管理を導入する場合、Recordモデルに再び外部キー追加が必要。

決定:

現段階ではゲスト投稿仕様を維持し、認証機能追加時に再設計する。

Recordデータのバックアップは週次で自動取得する方向で合意。

7) アクション（担当・期限）

浜崎：バックエンド Prisma 周りのコードリファクタリング（期限: 11/12）

村木：フロントUI統一とLifloFetchのテストコード作成（期限: 11/13）

両名：今週内にステージングデプロイ実施 → 動作確認会を設定（11/14 PM）

8) 参考（リンク/スクショ/チケット）

チケット: #127 (Record永続化の導入)

スクショ: assets/screenshots/20251110_review_fix.png

PR: (リポジトリ内リンク予定)

関連議事録: 20251105_backend-auth-me-404.md

✅ 備考
本修正により、記録→振り返り→再訪問のデータ永続が確認済み。
今後はJWTログイン機能導入を次フェーズとして進行予定。